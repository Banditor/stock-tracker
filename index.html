<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>מעקב מניות – Stock Tracker</title>
  <style>
    /* עיצוב כללי */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
      margin: 0;
      padding: 0;
      background-color: #eef2f7;
      color: #333;
    }
    header {
      background-color: #00539C;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 24px;
    }
    header button {
      background: #fff;
      color: #00539C;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-weight: bold;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    /* הגדרות API */
    #settings-panel {
      display: none;
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
      background: #f9f9f9;
    }
    #settings-panel input[type="text"] {
      width: 80%;
      padding: 6px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #settings-panel label {
      font-weight: bold;
    }
    #settings-panel button {
      padding: 8px 12px;
      background-color: #00539C;
      color: #fff;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      margin-top: 10px;
    }
    /* טבלת מניות בדף הראשי */
    #stocks-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    #stocks-table th, #stocks-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    #stocks-table th {
      background-color: #00539C;
      color: #fff;
    }
    .price-up {
      color: green;
      font-weight: bold;
    }
    .price-down {
      color: red;
      font-weight: bold;
    }
    .news-link {
      text-decoration: none;
      color: #00539C;
    }
    .remove-stock {
      background: transparent;
      border: none;
      color: #c00;
      cursor: pointer;
      font-weight: bold;
    }
    /* עמוד פרטים */
    #stock-details {
      display: none;
    }
    #stock-details h2 {
      text-align: center;
    }
    .back-button {
      margin-bottom: 20px;
      background-color: #00539C;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    .columns {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .column {
      flex: 1;
      min-width: 300px;
      border: 1px solid #ccc;
      padding: 15px;
      background: #fafafa;
      border-radius: 4px;
    }
    .column h3 {
      text-align: center;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }
    .news-item, .fund-item {
      border-bottom: 1px dashed #ddd;
      margin-bottom: 10px;
      padding-bottom: 5px;
    }
    .news-item a, .fund-item a {
      text-decoration: none;
      color: #00539C;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <h1>מעקב מניות</h1>
    <button id="toggle-settings">הגדרות API</button>
  </header>
  <div class="container">
    <!-- הגדרות API -->
    <div id="settings-panel">
      <h2>הגדרות API</h2>
      <div>
        <label for="alphaKey">Alpha Vantage API Key:</label><br>
        <input type="text" id="alphaKey" placeholder="Alpha Vantage API Key" value="NGLPQWAGSXDBTCB5">
      </div>
      <div>
        <label for="finnhubKey">Finnhub API Key:</label><br>
        <input type="text" id="finnhubKey" placeholder="Finnhub API Key" value="cuidauhr01qtqfmidisgcuidauhr01qtqfmidit0">
      </div>
      <div>
        <label for="fmpKey">Financial Modeling Prep API Key:</label><br>
        <input type="text" id="fmpKey" placeholder="FMP API Key" value="9RPgOrGpBmFvyKNIeWmHIQqlpLDc1RSf">
      </div>
      <button id="save-settings">שמור הגדרות</button>
    </div>

    <!-- דף ראשי: טבלה להצגת מניות -->
    <div id="main-page">
      <form id="add-stock-form" style="text-align:center; margin-bottom:20px;">
        <input type="text" id="stock-symbol" placeholder="הכנס סימול מניה (למשל: RXRX)" required>
        <button type="submit">הוסף</button>
      </form>
      <table id="stocks-table">
        <thead>
          <tr>
            <th>סימול</th>
            <th>מחיר אחרון (שינוי)</th>
            <th>שינוי היום</th>
            <th>חדשות אחרונות</th>
            <th>פעולות</th>
          </tr>
        </thead>
        <tbody id="stocks-table-body">
          <!-- שורות המניות נטענות כאן -->
        </tbody>
      </table>
      <button id="save-button">שמור עדכון ל-GitHub</button>
    </div>
    
    <!-- עמוד פרטים: מידע בסיסי, חדשות, קרנות -->
    <div id="stock-details">
      <button id="back-button" class="back-button">← חזור לרשימה</button>
      <h2 id="stock-title">מידע על מניה</h2>
      <div id="basic-info">
        <p>מחיר אחרון: <span id="last-price"></span></p>
        <p>שווי שוק: <span id="market-cap"></span></p>
        <p>מספר מניות כולל (Outstanding): <span id="total-shares"></span></p>
      </div>
      <div class="columns">
        <!-- עדכוני מבנה מניות -->
        <div class="column" id="corporate-news-column">
          <h3>עדכוני מבנה מניות (דילול/בייבאק/מענקי מניות)</h3>
          <div id="corporate-news-list"></div>
        </div>
        <!-- חדשות שוק -->
        <div class="column" id="general-news-column">
          <h3>חדשות שוק</h3>
          <div id="general-news-list"></div>
        </div>
        <!-- מידע על קרנות -->
        <div class="column" id="funds-column">
          <h3>מידע על קרנות</h3>
          <div id="funds-list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // מפתחות ברירת מחדל
    const defaultAlphaKey = "NGLPQWAGSXDBTCB5";
    const defaultFinnhubKey = "cuidauhr01qtqfmidisgcuidauhr01qtqfmidit0";
    const defaultFmpKey = "9RPgOrGpBmFvyKNIeWmHIQqlpLDc1RSf";
    const STOCK_LIST_KEY = 'stockList';

    // פונקציה לקבלת API Keys מ-localStorage או ברירת מחדל
    function getAPIKeys() {
      return {
        alphaKey: localStorage.getItem('alphaKey') || defaultAlphaKey,
        finnhubKey: localStorage.getItem('finnhubKey') || defaultFinnhubKey,
        fmpKey: localStorage.getItem('fmpKey') || defaultFmpKey
      };
    }

    // שמירת הגדרות API
    document.getElementById('save-settings').addEventListener('click', () => {
      const alphaKey = document.getElementById('alphaKey').value.trim();
      const finnhubKey = document.getElementById('finnhubKey').value.trim();
      const fmpKey = document.getElementById('fmpKey').value.trim();
      if(alphaKey) localStorage.setItem('alphaKey', alphaKey);
      if(finnhubKey) localStorage.setItem('finnhubKey', finnhubKey);
      if(fmpKey) localStorage.setItem('fmpKey', fmpKey);
      alert('הגדרות API נשמרו!');
    });

    // הצגת/הסתרת הגדרות API
    document.getElementById('toggle-settings').addEventListener('click', () => {
      const panel = document.getElementById('settings-panel');
      panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
    });

    // ניהול רשימת מניות ב-localStorage
    function getStockList() {
      let list = localStorage.getItem(STOCK_LIST_KEY);
      return list ? JSON.parse(list) : [];
    }
    function setStockList(list) {
      localStorage.setItem(STOCK_LIST_KEY, JSON.stringify(list));
    }

    // הוספת מניה חדשה
    document.getElementById('add-stock-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const symbolInput = document.getElementById('stock-symbol');
      const symbol = symbolInput.value.trim().toUpperCase();
      if(symbol) {
        let stockList = getStockList();
        if(!stockList.includes(symbol)) {
          stockList.push(symbol);
          setStockList(stockList);
          loadStocksTable();
        }
        symbolInput.value = '';
      }
    });

    // הסרת מניה
    function removeStock(symbol) {
      let stockList = getStockList();
      stockList = stockList.filter(item => item !== symbol);
      setStockList(stockList);
      loadStocksTable();
    }

    // הפונקציה שמחשבת "לפני כמה זמן" (לדוגמא: דקות/שעות/ימים)
    function timeSince(date) {
      const seconds = Math.floor((new Date() - new Date(date)) / 1000);
      let interval = Math.floor(seconds / 31536000);
      if (interval >= 1) return interval + " שנה";
      interval = Math.floor(seconds / 2592000);
      if (interval >= 1) return interval + " חודש";
      interval = Math.floor(seconds / 86400);
      if (interval >= 1) return interval + " יום";
      interval = Math.floor(seconds / 3600);
      if (interval >= 1) return interval + " שעה";
      interval = Math.floor(seconds / 60);
      if (interval >= 1) return interval + " דקה";
      return Math.floor(seconds) + " שניות";
    }

    // פונקציה לקבלת נתוני Quote ממקור Finnhub
    async function fetchQuote(symbol) {
      const { finnhubKey } = getAPIKeys();
      try {
        const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${finnhubKey}`);
        if(response.ok) {
          const data = await response.json();
          return data; // מכיל: c (מחיר אחרון), d (שינוי), dp (שינוי %), h, l, o, pc (מחיר סגירה קודם)
        }
      } catch(e) {
        console.error(e);
      }
      return null;
    }

    // פונקציה לקבלת חדשות ממספר API (כפי שהגדרנו)
    async function fetchNews(symbol) {
      const { finnhubKey, fmpKey } = getAPIKeys();
      let today = new Date();
      let pastDate = new Date();
      pastDate.setDate(today.getDate() - 30);
      const from = pastDate.toISOString().split('T')[0];
      const to = today.toISOString().split('T')[0];

      let newsFinnhub = [];
      try {
        const response = await fetch(`https://finnhub.io/api/v1/company-news?symbol=${symbol}&from=${from}&to=${to}&token=${finnhubKey}`);
        if(response.ok){
          newsFinnhub = await response.json();
        }
      } catch(e) {
        console.error(e);
      }

      let newsFMP = [];
      try {
        const response = await fetch(`https://financialmodelingprep.com/api/v3/stock_news?tickers=${symbol}&limit=10&apikey=${fmpKey}`);
        if(response.ok){
          newsFMP = await response.json();
        }
      } catch(e) {
        console.error(e);
      }

      const combinedNews = [];
      newsFinnhub.forEach(item => {
        combinedNews.push({
          date: item.datetime ? new Date(item.datetime * 1000) : new Date(),
          headline: item.headline,
          details: item.summary || "",
          url: item.url,
          source: "Finnhub"
        });
      });
      newsFMP.forEach(item => {
        combinedNews.push({
          date: item.publishedDate ? new Date(item.publishedDate) : new Date(),
          headline: item.title,
          details: item.text || "",
          url: item.url,
          source: "Financial Modeling Prep"
        });
      });
      // הסרת כפילויות על בסיס כותרת, מיון לפי תאריך יורד
      const uniqueNews = [];
      const headlines = new Set();
      combinedNews.sort((a, b) => b.date - a.date).forEach(item => {
        if(!headlines.has(item.headline)) {
          headlines.add(item.headline);
          uniqueNews.push(item);
        }
      });
      return uniqueNews;
    }

    // טוען את טבלת המניות בעמוד הראשי
    async function loadStocksTable() {
      const stockList = getStockList();
      const tableBody = document.getElementById('stocks-table-body');
      tableBody.innerHTML = '';

      for (const symbol of stockList) {
        // קבלת נתוני Quote
        const quote = await fetchQuote(symbol);
        // קבלת חדשות – לוקחים את שתי החדשות האחרונות
        const allNews = await fetchNews(symbol);
        const latestNews = allNews.slice(0, 2);

        // יצירת שורה בטבלה
        const tr = document.createElement('tr');

        // עמודת סימול – כלחיצה תעביר לעמוד הפרטים
        const tdSymbol = document.createElement('td');
        const link = document.createElement('a');
        link.href = window.location.pathname + '?symbol=' + symbol;
        link.textContent = symbol;
        tdSymbol.appendChild(link);
        tr.appendChild(tdSymbol);

        // עמודת מחיר אחרון – כולל אחוז שינוי (בין סוגריים)
        const tdLastPrice = document.createElement('td');
        if (quote && quote.c) {
          tdLastPrice.textContent = quote.c.toFixed(2) + " (" + (quote.dp ? quote.dp.toFixed(2) + "%": "0%") + ")";
        } else {
          tdLastPrice.textContent = "לא זמין";
        }
        tr.appendChild(tdLastPrice);

        // עמודת שינוי היום – מציג שינוי ודגל צבע (ירוק/אדום)
        const tdChange = document.createElement('td');
        if (quote) {
          const changeText = (quote.d >= 0 ? "+" : "") + (quote.d ? quote.d.toFixed(2) : "0");
          tdChange.textContent = changeText;
          tdChange.className = (quote.d >= 0 ? "price-up" : "price-down");
        } else {
          tdChange.textContent = "לא זמין";
        }
        tr.appendChild(tdChange);

        // עמודת חדשות – עד שתי חדשות אחרונות
        const tdNews = document.createElement('td');
        if (latestNews.length > 0) {
          latestNews.forEach(item => {
            const div = document.createElement('div');
            div.innerHTML = `<a class="news-link" href="${item.url}" target="_blank">${item.headline}</a> <br>
                             <small>${item.source} - לפני ${timeSince(item.date)}</small>`;
            tdNews.appendChild(div);
          });
        } else {
          tdNews.textContent = "אין חדשות";
        }
        tr.appendChild(tdNews);

        // עמודת פעולות – כפתור הסרה
        const tdActions = document.createElement('td');
        const removeBtn = document.createElement('button');
        removeBtn.textContent = "X";
        removeBtn.className = "remove-stock";
        removeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          removeStock(symbol);
        });
        tdActions.appendChild(removeBtn);
        tr.appendChild(tdActions);

        tableBody.appendChild(tr);
      }
    }

    // שמירה ל-GitHub (עדכון פרטים כנדרש)
    document.getElementById('save-button').addEventListener('click', () => {
      const stockList = getStockList();
      const username = 'YOUR_GITHUB_USERNAME';
      const repo = 'YOUR_REPO';
      const filePath = 'stockList.json';
      const token = 'YOUR_GITHUB_PERSONAL_ACCESS_TOKEN';

      fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filePath}`, {
        headers: {
          'Authorization': 'token ' + token
        }
      })
      .then(response => response.json())
      .then(data => {
        let sha = data.sha;
        let content = btoa(JSON.stringify(stockList, null, 2));
        const commitMessage = 'Update stock list';
        const body = {
          message: commitMessage,
          content: content,
          sha: sha
        };

        return fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filePath}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'token ' + token
          },
          body: JSON.stringify(body)
        });
      })
      .then(response => response.json())
      .then(result => {
        alert('רשימת המניות נשמרה בהצלחה ב-GitHub!');
      })
      .catch(error => {
        console.error('שגיאה בשמירה ל-GitHub:', error);
        alert('שגיאה בשמירה ל-GitHub. בדקו את הקונסול לפרטים.');
      });
    });

    // ניווט בין עמוד ראשי לעמוד פרטים
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const symbolParam = urlParams.get('symbol');
      if(symbolParam) {
        document.getElementById('main-page').style.display = 'none';
        document.getElementById('stock-details').style.display = 'block';
        loadStockDetails(symbolParam);
      } else {
        document.getElementById('main-page').style.display = 'block';
        document.getElementById('stock-details').style.display = 'none';
        loadStocksTable();
      }
    });

    // כפתור "חזור לרשימה" בעמוד פרטים
    document.getElementById('back-button').addEventListener('click', () => {
      window.location.href = window.location.pathname;
    });

    // טעינת פרטי מניה בעמוד הפרטים
    async function loadStockDetails(symbol) {
      document.getElementById('stock-title').textContent = 'מידע על מניה: ' + symbol;
      
      // קבלת Quote לנתוני מחיר אחרון ושינוי
      const quote = await fetchQuote(symbol);
      if (quote) {
        document.getElementById('last-price').textContent = quote.c ? quote.c.toFixed(2) + " (" + (quote.dp ? quote.dp.toFixed(2) + "%": "0%") + ")" : "לא זמין";
      } else {
        document.getElementById('last-price').textContent = "לא זמין";
      }
      
      // טעינת מידע בסיסי דרך Alpha Vantage
      const overview = await fetchStockOverview(symbol);
      document.getElementById('market-cap').textContent = overview.MarketCapitalization ? parseInt(overview.MarketCapitalization).toLocaleString() + " $" : "לא זמין";
      document.getElementById('total-shares').textContent = overview.SharesOutstanding ? parseInt(overview.SharesOutstanding).toLocaleString() : "לא זמין";

      // טעינת חדשות
      const allNews = await fetchNews(symbol);
      // פילטר לחדשות מבנה מניות – לפי מילות מפתח ספציפיות
      const corporateNews = allNews.filter(item => {
        const keywords = ["דילול", "בייבאק", "מענק", "מניה", "עובדים"];
        return keywords.some(keyword => item.headline.toLowerCase().includes(keyword.toLowerCase()));
      });
      // חדשות שוק – כל החדשות שאינן נכללות ב-corporateNews (לפי כותרת)
      const corporateSet = new Set(corporateNews.map(item => item.headline));
      const generalNews = allNews.filter(item => !corporateSet.has(item.headline));

      const corpNewsEl = document.getElementById('corporate-news-list');
      corpNewsEl.innerHTML = '';
      if(corporateNews.length === 0){
        corpNewsEl.innerHTML = '<p>אין עדכונים ספציפיים במבנה המניות.</p>';
      } else {
        corporateNews.forEach(item => {
          const div = document.createElement('div');
          div.className = 'news-item';
          div.innerHTML = `<strong>${item.date.toISOString().split('T')[0]}</strong>: 
                           <a class="news-link" href="${item.url}" target="_blank">${item.headline}</a> 
                           <br><small>${item.source} - לפני ${timeSince(item.date)}</small>`;
          corpNewsEl.appendChild(div);
        });
      }

      const genNewsEl = document.getElementById('general-news-list');
      genNewsEl.innerHTML = '';
      if(generalNews.length === 0){
        genNewsEl.innerHTML = '<p>אין חדשות שוק.</p>';
      } else {
        generalNews.forEach(item => {
          const div = document.createElement('div');
          div.className = 'news-item';
          div.innerHTML = `<strong>${item.date.toISOString().split('T')[0]}</strong>: 
                           <a class="news-link" href="${item.url}" target="_blank">${item.headline}</a> 
                           <br><small>${item.source} - לפני ${timeSince(item.date)}</small>`;
          genNewsEl.appendChild(div);
        });
      }

      // טעינת מידע על קרנות (נתונים לדוגמה)
      const fundsData = await fetchFundHoldings(symbol);
      const fundsEl = document.getElementById('funds-list');
      fundsEl.innerHTML = '';
      fundsData.forEach(fund => {
        const div = document.createElement('div');
        div.className = 'fund-item';
        let html = `<strong>קרן: ${fund.fund}</strong> (<a href="${fund.infoLink}" target="_blank">מקור</a>)<br>`;
        html += `אחזקה נוכחית: ${fund.currentHolding.shares.toLocaleString()} מניות, שווי: ${fund.currentHolding.marketValue.toLocaleString()} $<br>`;
        html += `<em>פעולות אחרונות:</em><ul>`;
        fund.actions.forEach(action => {
          html += `<li>${action.date}: ${action.shares.toLocaleString()} מניות, שווי: ${action.marketValue.toLocaleString()} $</li>`;
        });
        html += `</ul>`;
        div.innerHTML = html;
        fundsEl.appendChild(div);
      });
    }

    // פונקציה לקבלת מידע בסיסי על מניה מ-Alpha Vantage
    async function fetchStockOverview(symbol) {
      const { alphaKey } = getAPIKeys();
      try {
        const response = await fetch(`https://www.alphavantage.co/query?function=OVERVIEW&symbol=${symbol}&apikey=${alphaKey}`);
        if(response.ok){
          const data = await response.json();
          return data;
        }
      } catch (e) {
        console.error(e);
      }
      return {};
    }

    // נתוני קרנות – דוגמא (ניתן להחליף בקריאות API אמיתיות)
    async function fetchFundHoldings(symbol) {
      return [
        { 
          fund: 'ARKK', 
          currentHolding: { shares: 19400000, marketValue: 150000000 },
          actions: [
            { date: '2025-01-10', shares: 1830000, marketValue: 14500000 },
            { date: '2025-01-08', shares: 4700000, marketValue: 37000000 }
          ],
          infoLink: "https://ark-invest.com/"
        },
        { 
          fund: 'ARKG', 
          currentHolding: { shares: 336653, marketValue: 2700000 },
          actions: [
            { date: '2025-01-03', shares: 336653, marketValue: 2700000 }
          ],
          infoLink: "https://ark-invest.com/"
        }
      ];
    }
  </script>
</body>
</html>
