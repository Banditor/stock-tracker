<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>מעקב מניות – Stock Tracker</title>
  <style>
    /* עיצוב כללי */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      direction: rtl;
      margin: 0;
      padding: 0;
      background-color: #eef2f7;
      color: #333;
    }
    header {
      background-color: #00539C;
      color: #fff;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
      font-size: 24px;
    }
    header button {
      background: #fff;
      color: #00539C;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
      font-weight: bold;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    /* תפריט מניות */
    #add-stock-form {
      text-align: center;
      margin-bottom: 20px;
    }
    #add-stock-form input[type="text"] {
      padding: 8px;
      width: 200px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #add-stock-form button {
      padding: 8px 12px;
      font-size: 16px;
      margin-left: 5px;
      border: none;
      background-color: #00539C;
      color: #fff;
      cursor: pointer;
      border-radius: 4px;
    }
    .stock-list {
      list-style: none;
      padding: 0;
      text-align: center;
    }
    .stock-list li {
      display: inline-block;
      margin: 5px 10px;
      padding: 5px 10px;
      background: #f0f4f8;
      border-radius: 4px;
    }
    .stock-list a {
      text-decoration: none;
      color: #00539C;
      font-weight: bold;
    }
    .remove-stock {
      background: transparent;
      border: none;
      color: #c00;
      cursor: pointer;
      font-weight: bold;
      margin-right: 5px;
    }
    /* הגדרות API */
    #settings-panel {
      display: none;
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
      background: #f9f9f9;
    }
    #settings-panel input[type="text"] {
      width: 80%;
      padding: 6px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #settings-panel label {
      font-weight: bold;
    }
    #settings-panel button {
      padding: 8px 12px;
      background-color: #00539C;
      color: #fff;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      margin-top: 10px;
    }
    /* עמוד פרטים */
    #stock-details {
      display: none;
    }
    #stock-details h2 {
      text-align: center;
    }
    .columns {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .column {
      flex: 1;
      min-width: 300px;
      border: 1px solid #ccc;
      padding: 15px;
      background: #fafafa;
      border-radius: 4px;
    }
    .column h3 {
      text-align: center;
      border-bottom: 1px solid #ccc;
      padding-bottom: 5px;
    }
    .news-item, .fund-item {
      border-bottom: 1px dashed #ddd;
      margin-bottom: 10px;
      padding-bottom: 5px;
    }
    .news-item a, .fund-item a {
      text-decoration: none;
      color: #00539C;
      font-size: 14px;
    }
    .back-button {
      margin-bottom: 20px;
      background-color: #00539C;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    /* כפתור שמירה ל-GitHub */
    #save-button {
      background-color: #28a745;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 10px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body>
  <header>
    <h1>מעקב מניות</h1>
    <button id="toggle-settings">הגדרות API</button>
  </header>
  <div class="container">
    <!-- הגדרות API -->
    <div id="settings-panel">
      <h2>הגדרות API</h2>
      <div>
        <label for="alphaKey">Alpha Vantage API Key:</label><br>
        <input type="text" id="alphaKey" placeholder="Alpha Vantage API Key">
      </div>
      <div>
        <label for="finnhubKey">Finnhub API Key:</label><br>
        <input type="text" id="finnhubKey" placeholder="Finnhub API Key">
      </div>
      <div>
        <label for="fmpKey">Financial Modeling Prep API Key:</label><br>
        <input type="text" id="fmpKey" placeholder="FMP API Key">
      </div>
      <button id="save-settings">שמור הגדרות</button>
    </div>

    <!-- עמוד ראשי: הוספת מניות לרשימה -->
    <div id="main-page">
      <form id="add-stock-form">
        <input type="text" id="stock-symbol" placeholder="הכנס סימול מניה (למשל: RXRX)" required>
        <button type="submit">הוסף</button>
      </form>
      <ul id="stock-list" class="stock-list"></ul>
      <button id="save-button">שמור עדכון ל-GitHub</button>
    </div>
    
    <!-- עמוד פרטים: מידע בסיסי, חדשות, קרנות -->
    <div id="stock-details">
      <button id="back-button" class="back-button">← חזור לרשימה</button>
      <h2 id="stock-title">מידע על מניה</h2>
      <div id="basic-info">
        <p>שווי שוק: <span id="market-cap"></span></p>
        <p>מספר מניות כולל (Outstanding): <span id="total-shares"></span></p>
      </div>
      <div class="columns">
        <!-- עמודה לעדכוני מבנה מניות -->
        <div class="column" id="corporate-news-column">
          <h3>עדכוני מבנה מניות (דילול/בייבאק/מענקי מניות)</h3>
          <div id="corporate-news-list"></div>
        </div>
        <!-- עמודה לחדשות שוק כלליות -->
        <div class="column" id="general-news-column">
          <h3>חדשות שוק</h3>
          <div id="general-news-list"></div>
        </div>
        <!-- עמודה לקרנות (נתונים מדומים) -->
        <div class="column" id="funds-column">
          <h3>מידע על קרנות</h3>
          <div id="funds-list"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // מפתחות ברירת מחדל
    const defaultAlphaKey = "NGLPQWAGSXDBTCB5";
    const defaultFinnhubKey = "cuidauhr01qtqfmidisgcuidauhr01qtqfmidit0";
    const defaultFmpKey = "9RPgOrGpBmFvyKNIeWmHIQqlpLDc1RSf";
    const STOCK_LIST_KEY = 'stockList';

    // טעינת מפתחות API מ-localStorage או שימוש בברירת מחדל
    function getAPIKeys() {
      return {
        alphaKey: localStorage.getItem('alphaKey') || defaultAlphaKey,
        finnhubKey: localStorage.getItem('finnhubKey') || defaultFinnhubKey,
        fmpKey: localStorage.getItem('fmpKey') || defaultFmpKey
      };
    }

    // שמירת הגדרות API
    document.getElementById('save-settings').addEventListener('click', () => {
      const alphaKey = document.getElementById('alphaKey').value.trim();
      const finnhubKey = document.getElementById('finnhubKey').value.trim();
      const fmpKey = document.getElementById('fmpKey').value.trim();
      if(alphaKey) localStorage.setItem('alphaKey', alphaKey);
      if(finnhubKey) localStorage.setItem('finnhubKey', finnhubKey);
      if(fmpKey) localStorage.setItem('fmpKey', fmpKey);
      alert('הגדרות API נשמרו!');
    });

    // הצגת/הסתרת הגדרות API
    document.getElementById('toggle-settings').addEventListener('click', () => {
      const panel = document.getElementById('settings-panel');
      panel.style.display = panel.style.display === 'none' || panel.style.display === '' ? 'block' : 'none';
    });

    // פונקציות לדאטה – קריאות API
    async function fetchStockOverview(symbol) {
      const { alphaKey } = getAPIKeys();
      try {
        const response = await fetch(`https://www.alphavantage.co/query?function=OVERVIEW&symbol=${symbol}&apikey=${alphaKey}`);
        if(response.ok){
          const data = await response.json();
          return data;
        }
      } catch (e) {
        console.error(e);
      }
      return {};
    }

    async function fetchNews(symbol) {
      const { finnhubKey, fmpKey } = getAPIKeys();
      let today = new Date();
      let pastDate = new Date();
      pastDate.setDate(today.getDate() - 30);
      const from = pastDate.toISOString().split('T')[0];
      const to = today.toISOString().split('T')[0];

      let newsFinnhub = [];
      try {
        const response = await fetch(`https://finnhub.io/api/v1/company-news?symbol=${symbol}&from=${from}&to=${to}&token=${finnhubKey}`);
        if(response.ok){
          newsFinnhub = await response.json();
        }
      } catch(e) {
        console.error(e);
      }

      let newsFMP = [];
      try {
        const response = await fetch(`https://financialmodelingprep.com/api/v3/stock_news?tickers=${symbol}&limit=10&apikey=${fmpKey}`);
        if(response.ok){
          newsFMP = await response.json();
        }
      } catch(e) {
        console.error(e);
      }

      // עיבוד ואיחוד תוצאות עם פורמט אחיד
      const combinedNews = [];
      newsFinnhub.forEach(item => {
        combinedNews.push({
          date: item.datetime ? new Date(item.datetime * 1000).toISOString().split('T')[0] : '',
          headline: item.headline,
          details: item.summary || "",
          url: item.url,
          source: "Finnhub"
        });
      });
      newsFMP.forEach(item => {
        combinedNews.push({
          date: item.publishedDate ? item.publishedDate.split(' ')[0] : '',
          headline: item.title,
          details: item.text || "",
          url: item.url,
          source: "Financial Modeling Prep"
        });
      });
      // מיון לפי תאריך יורד
      combinedNews.sort((a, b) => new Date(b.date) - new Date(a.date));
      return combinedNews;
    }

    // פילטור חדשות לעדכוני מבנה מניות לפי מילים מפתח
    function filterCorporateNews(news) {
      const keywords = ["dilution", "buyback", "grant", "stock", "employee", "דילול", "בייבאק", "מניה", "עובדים"];
      return news.filter(item => {
        return keywords.some(keyword => item.headline.toLowerCase().includes(keyword.toLowerCase()));
      });
    }

    // הפונקציה שתציג חדשות כלליות – אלו שאינן נכללות בעדכוני מבנה מניות
    function filterGeneralNews(news, corporateNews) {
      const corporateSet = new Set(corporateNews.map(item => item.headline));
      return news.filter(item => !corporateSet.has(item.headline));
    }

    // נתוני קרנות – כאן מדומים, ניתן להחליף בקריאות API במידת הצורך
    async function fetchFundHoldings(symbol) {
      // נתונים לדוגמה
      return [
        { 
          fund: 'ARKK', 
          currentHolding: { shares: 19400000, marketValue: 150000000 },
          actions: [
            { date: '2025-01-10', shares: 1830000, marketValue: 14500000 },
            { date: '2025-01-08', shares: 4700000, marketValue: 37000000 }
          ],
          infoLink: "https://ark-invest.com/"
        },
        { 
          fund: 'ARKG', 
          currentHolding: { shares: 336653, marketValue: 2700000 },
          actions: [
            { date: '2025-01-03', shares: 336653, marketValue: 2700000 }
          ],
          infoLink: "https://ark-invest.com/"
        }
      ];
    }

    // ניהול רשימת מניות ב-localStorage
    function getStockList() {
      let list = localStorage.getItem(STOCK_LIST_KEY);
      return list ? JSON.parse(list) : [];
    }
    function setStockList(list) {
      localStorage.setItem(STOCK_LIST_KEY, JSON.stringify(list));
    }

    // עדכון רשימת מניות בעמוד הראשי
    function loadStockList() {
      const stockList = getStockList();
      const listEl = document.getElementById('stock-list');
      listEl.innerHTML = '';
      stockList.forEach(symbol => {
        const li = document.createElement('li');
        // קישור לעמוד פרטים
        const link = document.createElement('a');
        link.href = window.location.pathname + '?symbol=' + symbol;
        link.textContent = symbol;
        li.appendChild(link);
        // כפתור הסרה
        const removeBtn = document.createElement('button');
        removeBtn.textContent = "X";
        removeBtn.className = "remove-stock";
        removeBtn.addEventListener('click', (e) => {
          e.preventDefault();
          removeStock(symbol);
        });
        li.insertBefore(removeBtn, link);
        listEl.appendChild(li);
      });
    }
    function removeStock(symbol) {
      let stockList = getStockList();
      stockList = stockList.filter(item => item !== symbol);
      setStockList(stockList);
      loadStockList();
    }

    // טיפול בהוספת מניה חדשה
    document.getElementById('add-stock-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const symbolInput = document.getElementById('stock-symbol');
      const symbol = symbolInput.value.trim().toUpperCase();
      if(symbol) {
        let stockList = getStockList();
        if(!stockList.includes(symbol)) {
          stockList.push(symbol);
          setStockList(stockList);
          loadStockList();
        }
        symbolInput.value = '';
      }
    });

    // שמירה ל-GitHub (יש לעדכן פרטים בהתאם לחשבון שלכם)
    document.getElementById('save-button').addEventListener('click', () => {
      const stockList = getStockList();
      const username = 'YOUR_GITHUB_USERNAME';
      const repo = 'YOUR_REPO';
      const filePath = 'stockList.json';
      const token = 'YOUR_GITHUB_PERSONAL_ACCESS_TOKEN';

      fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filePath}`, {
        headers: {
          'Authorization': 'token ' + token
        }
      })
      .then(response => response.json())
      .then(data => {
        let sha = data.sha;
        let content = btoa(JSON.stringify(stockList, null, 2));
        const commitMessage = 'Update stock list';
        const body = {
          message: commitMessage,
          content: content,
          sha: sha
        };

        return fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filePath}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'token ' + token
          },
          body: JSON.stringify(body)
        });
      })
      .then(response => response.json())
      .then(result => {
        alert('רשימת המניות נשמרה בהצלחה ב-GitHub!');
      })
      .catch(error => {
        console.error('שגיאה בשמירה ל-GitHub:', error);
        alert('שגיאה בשמירה ל-GitHub. בדקו את הקונסול לפרטים.');
      });
    });

    // ניווט בין עמוד ראשי לעמוד פרטים
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const symbolParam = urlParams.get('symbol');
      if(symbolParam) {
        document.getElementById('main-page').style.display = 'none';
        document.getElementById('stock-details').style.display = 'block';
        loadStockDetails(symbolParam);
      } else {
        document.getElementById('main-page').style.display = 'block';
        document.getElementById('stock-details').style.display = 'none';
        loadStockList();
      }
    });

    // טעינת פרטי מניה והצגת הנתונים בעמוד הפרטים
    async function loadStockDetails(symbol) {
      document.getElementById('stock-title').textContent = 'מידע על מניה: ' + symbol;
      // טעינת מידע בסיסי דרך Alpha Vantage
      const overview = await fetchStockOverview(symbol);
      document.getElementById('market-cap').textContent = overview.MarketCapitalization ? parseInt(overview.MarketCapitalization).toLocaleString() + ' $' : 'לא זמין';
      document.getElementById('total-shares').textContent = overview.SharesOutstanding ? parseInt(overview.SharesOutstanding).toLocaleString() : 'לא זמין';

      // טעינת חדשות מכל המקורות
      const allNews = await fetchNews(symbol);
      const corporateNews = filterCorporateNews(allNews);
      const generalNews = filterGeneralNews(allNews, corporateNews);
      
      const corpNewsEl = document.getElementById('corporate-news-list');
      corpNewsEl.innerHTML = '';
      if(corporateNews.length === 0){
        corpNewsEl.innerHTML = '<p>אין עדכונים ספציפיים במבנה המניות.</p>';
      } else {
        corporateNews.forEach(item => {
          const div = document.createElement('div');
          div.className = 'news-item';
          div.innerHTML = `<strong>${item.date}</strong>: <a href="${item.url}" target="_blank">${item.headline}</a> <br><small>מקור: ${item.source}</small>`;
          corpNewsEl.appendChild(div);
        });
      }

      const genNewsEl = document.getElementById('general-news-list');
      genNewsEl.innerHTML = '';
      if(generalNews.length === 0){
        genNewsEl.innerHTML = '<p>אין חדשות כלליות.</p>';
      } else {
        generalNews.forEach(item => {
          const div = document.createElement('div');
          div.className = 'news-item';
          div.innerHTML = `<strong>${item.date}</strong>: <a href="${item.url}" target="_blank">${item.headline}</a> <br><small>מקור: ${item.source}</small>`;
          genNewsEl.appendChild(div);
        });
      }

      // טעינת מידע על קרנות (נתונים לדוגמה)
      const fundsData = await fetchFundHoldings(symbol);
      const fundsEl = document.getElementById('funds-list');
      fundsEl.innerHTML = '';
      fundsData.forEach(fund => {
        const div = document.createElement('div');
        div.className = 'fund-item';
        let html = `<strong>קרן: ${fund.fund}</strong> (<a href="${fund.infoLink}" target="_blank">מקור</a>)<br>`;
        html += `אחזקה נוכחית: ${fund.currentHolding.shares.toLocaleString()} מניות, שווי: ${fund.currentHolding.marketValue.toLocaleString()} $<br>`;
        html += `<em>פעולות אחרונות:</em><ul>`;
        fund.actions.forEach(action => {
          html += `<li>${action.date}: ${action.shares.toLocaleString()} מניות, שווי: ${action.marketValue.toLocaleString()} $</li>`;
        });
        html += `</ul>`;
        div.innerHTML = html;
        fundsEl.appendChild(div);
      });
    }
  </script>
</body>
</html>
